<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>WebRTC QR Chat (no server)</title>
    <style>
        :root{--b:#111;--m:#666;--bg:#fff;--card:#f6f6f6}
        html,body{margin:0;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);background:var(--bg);color:var(--b);font-family:system-ui,Segoe UI,Arial,sans-serif;-webkit-tap-highlight-color: transparent;overscroll-behavior-y:none}
        header{padding:12px 16px;border-bottom:1px solid #e5e5e5;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        header h1{font-size:16px;margin:0;font-weight:600}
        header .actions{display:flex;gap:8px;flex-wrap:wrap}
        button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
        button:disabled{opacity:.5;cursor:not-allowed}
        #wrap{display:grid;grid-template-columns:1fr 360px;gap:16px;padding:16px}
        @media (max-width: 900px){#wrap{grid-template-columns:1fr}}
        @media (max-width: 640px){
            header{padding:10px 12px;gap:8px}
            header h1{font-size:14px}
            .actions button{flex:1}
            #wrap{padding:12px;gap:12px}
            #log{height:45vh}
            #qr, #videoWrap{background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:10px;display:flex;align-items:center;justify-content:center;min-height:320px;max-width:100%}
            button{padding:12px 14px;font-size:16px}
            input[type=text]{padding:12px;font-size:16px}
        }
        #chatCard,#sideCard{background:var(--card);border:1px solid #eaeaea;border-radius:10px;padding:12px}
        #log{height:52vh;min-height:260px;overflow:auto;padding:8px;background:#fff;border:1px solid #eee;border-radius:8px}
        .sys{color:#7a7a7a;font-size:12px;margin:6px 0}
        .msg{margin:8px 0;padding:8px 10px;border-radius:10px;max-width:85%}
        .mine{background:#e8f4ff;margin-left:auto}
        .theirs{background:#f1f1f1;margin-right:auto}
        #form{display:flex;gap:8px;margin-top:10px}
        input[type=text]{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
        #qr, #videoWrap{background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:10px;display:flex;align-items:center;justify-content:center;min-height:320px}
        #video{width:100%;height:auto;border-radius:6px}
        #status{font-size:12px;color:#555}
        .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
        .hint{font-size:12px;color:#777}
        label{font-size:12px;color:#333}
        @media (prefers-color-scheme: dark){
            :root{--b:#eaeaea;--m:#9aa0a6;--bg:#0b0b0b;--card:#161616}
            body{background:var(--bg);color:var(--b)}
            #log{background:#0f0f0f;border-color:#242424}
            #chatCard,#sideCard{border-color:#242424}
            button{background:#111;border-color:#2a2a2a;color:#eaeaea}
            input[type=text]{background:#0f0f0f;color:#eaeaea;border-color:#2a2a2a}
        }
    </style>
</head>
<body>
<header>
    <h1>WebRTC QR Chat (no server)</h1>
    <div class="actions">
        <button id="btnOffer">1) Create Offer (P1)</button>
        <button id="btnScan">2) Scan QR (Offer/Answer)</button>
        <button id="btnStopScan">Stop Scan</button>
        <button id="btnTests" title="Run self-tests">Run tests</button>
    </div>
    <div id="status">Idle</div>
</header>

<div id="wrap">
    <section id="chatCard">
        <div class="row">
            <label>Display name</label>
            <input id="nick" type="text" placeholder="Your name" value="You" />
        </div>
        <div id="log"></div>
        <form id="form">
            <input id="input" type="text" placeholder="Type a message…" autocomplete="off" />
            <button id="btnSend" type="submit" disabled>Send</button>
        </form>
        <div class="hint">Start as P1 on one device (Create Offer), then on the other device press Scan to read the QR. The answer QR will appear on the second device—scan it from the first.
        </div>
    </section>

    <aside id="sideCard">
        <div id="qr">QR will appear here</div>
        <div id="videoWrap" hidden>
            <video id="video" autoplay muted playsinline></video>
            <div class="hint">Point camera at the peer's QR.</div>
        </div>
        <div id="qa" hidden></div>
    </aside>
</div>

<!-- libs: compression, jsQR fallback. QRCode will be loaded dynamically -->
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    // ---------- Basic helpers ----------
    const el = s => document.querySelector(s);
    const status = (t)=> el('#status').textContent = t;
    const logEl = el('#log');
    function sys(t){
        const d = document.createElement('div');
        d.className='sys'; d.textContent = t; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
    }
    function addMsg(text, mine=false){
        const d=document.createElement('div'); d.className='msg ' + (mine?'mine':'theirs'); d.textContent=text;
        logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
    }

    // ---------- Dynamic script loader & guards ----------
    function loadScript(src){
        return new Promise((resolve, reject)=>{
            const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed '+src));
            document.head.appendChild(s);
        });
    }
    let qrLibPromise=null;
    function ensureQRCode(){
        if (window.QRCode && (QRCode.toCanvas || typeof QRCode==='function')) return Promise.resolve();
        if (!qrLibPromise){
            // Try multiple CDNs for resiliency
            const cdns=[
                'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
                'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js'
            ];
            qrLibPromise = cdns.reduce((p, url)=> p.catch(()=>loadScript(url)), Promise.reject())
                .then(()=>{ if (!(window.QRCode && (QRCode.toCanvas || typeof QRCode==='function'))) throw new Error('QRCode still undefined'); });
        }
        return qrLibPromise;
    }

    // ---------- QR encode/decode (compressed SDP) ----------
    function enc(obj){
        if (!window.pako) throw new Error('Compression lib missing');
        const s = JSON.stringify(obj);
        const def = pako.deflate(s); let bin=''; def.forEach(b=> bin+=String.fromCharCode(b));
        return btoa(bin);
    }
    function dec(b64){
        if (!window.pako) throw new Error('Compression lib missing');
        const bin = atob(b64); const arr = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
        const s = pako.inflate(arr, {to:'string'}); return JSON.parse(s);
    }

    async function showQR(text){
        try{ await ensureQRCode(); }catch(e){ sys('QR library load failed: '+e.message); return; }
        const qr = el('#qr'); qr.innerHTML='';
        if(QRCode.toCanvas){
            QRCode.toCanvas(text, { errorCorrectionLevel:'M', margin:0, scale:6 }, (err, canvas)=>{
                if(err){ sys('QR error: '+err.message); return; }
                canvas.style.width = '100%'; canvas.style.height = 'auto'; qr.appendChild(canvas);
            });
        } else if(typeof QRCode==='function'){
            new QRCode(qr, {text:text, width:256, height:256});
        } else {
            sys('QR generation unavailable');
        }
    }

    // ---------- Camera scan (BarcodeDetector || jsQR) ----------
    let scanning=false, stream=null, raf=null;
    const video = el('#video');
    video.addEventListener('loadedmetadata',()=>{ video.play?.().catch(()=>{}); });

    async function startScan(){
        if(scanning) return; scanning=true; el('#videoWrap').hidden=false;
        try{
            stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } } });
        }catch(err){ sys('Camera error: '+err.message); scanning=false; return; }
        video.srcObject = stream; sys('Scanner started.');

        const hasBD = 'BarcodeDetector' in window && typeof BarcodeDetector.getSupportedFormats === 'function'
            ? await BarcodeDetector.getSupportedFormats().then(f=>f.includes('qr_code')).catch(()=>false)
            : false;

        if(hasBD){
            const det = new BarcodeDetector({ formats:['qr_code'] });
            const tick = async()=>{
                if(!scanning) return;
                try{
                    const codes = await det.detect(video);
                    if(codes && codes.length){ await stopScan(); onScanned(codes[0].rawValue); return; }
                }catch{}
                raf=requestAnimationFrame(tick);
            }; raf=requestAnimationFrame(tick);
        } else if (window.jsQR){
            const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
            const tick=()=>{
                if(!scanning) return; const w=video.videoWidth,h=video.videoHeight;
                if(w&&h){ canvas.width=w; canvas.height=h; ctx.drawImage(video,0,0,w,h);
                    const img=ctx.getImageData(0,0,w,h); const code=jsQR(img.data,w,h);
                    if(code && code.data){ stopScan().then(()=> onScanned(code.data)); return; }
                }
                raf=requestAnimationFrame(tick);
            }; raf=requestAnimationFrame(tick);
        } else {
            sys('No QR scanner available. Your browser lacks BarcodeDetector and jsQR.');
        }
    }

    async function stopScan(){
        scanning=false; el('#videoWrap').hidden=true; if(raf) cancelAnimationFrame(raf); raf=null;
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
        sys('Scanner stopped.');
    }

    // ---------- WebRTC ----------
    let pc, dc; let ctx; // ctx holds {ready}

    function newPC(){
        pc = new RTCPeerConnection({ iceServers: [] }); // For internet, add STUN.
        const ready = new Promise(res=>{
            if(pc.iceGatheringState==='complete') return res();
            pc.addEventListener('icegatheringstatechange', ()=>{ if(pc.iceGatheringState==='complete') res(); });
        });
        pc.onconnectionstatechange=()=>{
            status('State: '+pc.connectionState);
            const sendBtn = el('#btnSend');
            if(pc.connectionState==='connected'){ sys('Connected. You can chat now.'); sendBtn.disabled=false; }
            if(pc.connectionState==='disconnected'||pc.connectionState==='failed'){ sendBtn.disabled=true; }
        };
        pc.ondatachannel=(e)=>{ dc=e.channel; wireDC(); };
        return { ready };
    }

    function wireDC(){
        dc.onopen=()=>{ sys('Channel open'); el('#btnSend').disabled=false; };
        dc.onclose=()=>{ sys('Channel closed'); el('#btnSend').disabled=true; };
        dc.onmessage=(e)=>{ addMsg(e.data,false); };
    }

    async function createOffer(){
        ctx = newPC();
        dc = pc.createDataChannel('chat'); wireDC();
        let offer;
        try{
            offer = await pc.createOffer(); await pc.setLocalDescription(offer);
        }catch(e){ sys('Offer error: '+e.message); return; }
        await ctx.ready; // wait ICE complete so one QR is enough
        try{ await showQR(enc(pc.localDescription)); }catch(e){ sys('QR show error: '+e.message); }
        status('Offer ready — show QR to peer'); sys('Offer ready. Ask peer to scan this QR.');
    }

    async function onScanned(qrText){
        let desc; try{ desc = dec(qrText); }catch(e){ sys('Scan parse error: '+e.message); return; }
        if(!pc) ctx = newPC();
        try{ await pc.setRemoteDescription(desc); }catch(e){ sys('Remote desc error: '+e.message); return; }
        sys('Applied remote '+desc.type);
        if(desc.type==='offer'){
            let answer; try{ answer = await pc.createAnswer(); await pc.setLocalDescription(answer); }catch(e){ sys('Answer error: '+e.message); return; }
            await ctx.ready; await showQR(enc(pc.localDescription));
            status('Answer ready — show back to the offerer'); sys('Answer ready. Show this QR back to P1.');
        } else {
            status('Answer applied — waiting for channel...');
        }
    }

    function sendMsg(text){
        if(!dc || dc.readyState!=='open'){ sys('Channel not open'); return; }
        const name = el('#nick').value.trim() || 'You';
        const msg = name+': '+text; dc.send(msg); addMsg(msg,true);
    }

    // ---------- Tests ----------
    const TESTS=[]; function test(name, fn){ TESTS.push({name, fn}); }
    async function runSelfTests(){
        sys('Running self-tests…'); let passed=0; for(const t of TESTS){
            try{ await t.fn(); sys('✓ '+t.name); passed++; } catch(e){ sys('✗ '+t.name+' — '+(e?.message||e)); }
        } sys('Self-tests complete: '+passed+'/'+TESTS.length+' passed.');
    }

    test('enc/dec roundtrip', ()=>{
        const obj={type:'offer', sdp:'v=0\no=- 0 0 IN IP4 127.0.0.1\n'}; const b64=enc(obj); const back=dec(b64);
        if(back.type!==obj.type || back.sdp!==obj.sdp) throw new Error('Mismatch');
    });
    test('ensureQRCode loads', async ()=>{ await ensureQRCode(); if(!(window.QRCode)) throw new Error('No QRCode'); });

    // ---------- Wire UI ----------
    el('#btnOffer').onclick = createOffer;
    el('#btnScan').onclick = startScan;
    el('#btnStopScan').onclick = stopScan;
    el('#btnTests').onclick = runSelfTests;
    el('#form').addEventListener('submit', (e)=>{ e.preventDefault(); const t=el('#input'); const v=t.value.trim(); if(v){ sendMsg(v); t.value=''; }});

    // Auto-run quick tests
    window.addEventListener('load', ()=>{ setTimeout(runSelfTests, 0); });
</script>
</body>
</html>
